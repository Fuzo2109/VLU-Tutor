<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Tutor Dashboard - VLU Tutor System</title>
    <link rel="stylesheet" href="css/layout-base.css">
    <link rel="stylesheet" href="css/tutor-theme.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="wrapper">
        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <h3>VLU Tutor System</h3>
                <p>Tutor Dashboard</p>
            </div>
            <ul class="nav-menu">
                <li class="nav-item active">
                    <a href="#" class="nav-link">
                        <i class="nav-icon fas fa-tachometer-alt"></i>
                        Dashboard
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="showRescheduleRequests()">
                        <i class="nav-icon fas fa-clock"></i>
                        Reschedule Requests
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="showMyScheduleModal()">
                        <i class="nav-icon fas fa-calendar"></i>
                        My Schedule
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="showCreateLessonModal()">
                        <i class="nav-icon fas fa-plus-circle"></i>
                        Create Lessons
                    </a>
                </li>

                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="showProfileModal()">
                        <i class="nav-icon fas fa-user"></i>
                        Profile
                    </a>
                </li>
                <li class="nav-item">
                    <a href="index.html" class="nav-link">
                        <i class="nav-icon fas fa-sign-out-alt"></i>
                        Logout
                    </a>
                </li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="header">
                <div class="header-left">
                    <h1>Tutor Dashboard</h1>
                    <p>Welcome back, Dr. Sarah Johnson</p>
                </div>
                <div class="header-right">
                    <div class="user-info">
                        <span>Dr. Sarah Johnson</span>
                        <i class="fas fa-user-circle"></i>
                    </div>
                </div>
            </header>

            <!-- Dashboard Content -->
            <div class="content">
                <!-- Stats Cards -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-info">
                            <h3>24</h3>
                            <p>Active Students</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stat-info">
                            <h3>156</h3>
                            <p>Hours Taught</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-star"></i>
                        </div>
                        <div class="stat-info">
                            <h3>4.8</h3>
                            <p>Average Rating</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-calendar-check"></i>
                        </div>
                        <div class="stat-info">
                            <h3>8</h3>
                            <p>Upcoming Lessons</p>
                        </div>
                    </div>
                </div>

                <!-- Reschedule Requests Section -->
                <div class="section">
                    <div class="section-header">
                        <h2>New Student Requests</h2>
                        <button onclick="refreshRequests()" class="btn btn-primary">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>STUDENT</th>
                                    <th>SUBJECT</th>
                                    <th>REQUEST DATE</th>
                                    <th>ACTION</th>
                                </tr>
                            </thead>
                            <tbody id="rescheduleRequestsTable">
                                <!-- Requests will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Charts Section -->
                <div class="charts-grid">
                    <div class="chart-card">
                        <h3>Weekly Schedule</h3>
                        <canvas id="weeklyScheduleChart"></canvas>
                    </div>
                    <div class="chart-card">
                        <h3>Student Performance</h3>
                        <canvas id="studentPerformanceChart"></canvas>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Request Detail Modal -->
    <div id="requestDetailModal" class="modal" style="display: none; position: fixed; z-index: 10001; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); align-items: center; justify-content: center;" onclick="closeRequestDetailModal()">
        <div class="modal-content" style="width: 90%; max-width: 600px; max-height: 90vh; overflow: hidden; background: white; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); position: relative;" onclick="event.stopPropagation();">
            <!-- Modal Header -->
            <div class="modal-header" style="background: linear-gradient(135deg, #4caf50, #45a049); color: white; padding: 20px 24px; border-radius: 12px 12px 0 0; position: relative;">
                <button onclick="closeRequestDetailModal()" style="position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; transition: background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                    <i class="fas fa-times"></i>
                </button>
                <div style="display: flex; align-items: center; gap: 16px;">
                    <i class="fas fa-clock" style="font-size: 1.5rem;"></i>
                    <div>
                        <h2 id="modalTitle" style="margin: 0; font-size: 1.6rem;">Reschedule Request Details</h2>
                        <div id="modalSubtitle" style="font-size: 0.9rem; opacity: 0.9;">Review student's request</div>
                    </div>
                </div>
            </div>
            
            <!-- Modal Content -->
            <div style="padding: 24px; overflow-y: auto; max-height: calc(90vh - 140px);">
                <div id="requestDetails">
                    <!-- Request details will be loaded here -->
                </div>
                
                <!-- Action Buttons -->
                <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px; padding-top: 20px; border-top: 1px solid #e0e0e0;">
                    <button onclick="closeRequestDetailModal()" style="background: #6c757d; color: white; border: none; border-radius: 8px; padding: 12px 24px; font-size: 1rem; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='#5a6268'" onmouseout="this.style.background='#6c757d'">
                        Cancel
                    </button>
                    <button onclick="rejectRequest()" style="background: #dc3545; color: white; border: none; border-radius: 8px; padding: 12px 24px; font-size: 1rem; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='#c82333'" onmouseout="this.style.background='#dc3545'">
                        <i class="fas fa-times"></i> Reject
                    </button>
                    <button onclick="approveRequest()" style="background: #28a745; color: white; border: none; border-radius: 8px; padding: 12px 24px; font-size: 1rem; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='#218838'" onmouseout="this.style.background='#28a745'">
                        <i class="fas fa-check"></i> Approve
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- My Schedule Modal -->
    <div id="myScheduleModal" style="display: none; position: fixed; z-index: 10006; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); align-items: center; justify-content: center;" onclick="closeMyScheduleModal()">
        <div class="modal-content" style="width: 95%; max-width: 1200px; max-height: 90vh; overflow: hidden; background: white; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); position: relative;" onclick="event.stopPropagation();">
            <!-- Modal Header -->
            <div style="background: linear-gradient(135deg, var(--tutor-primary), #1976d2); color: white; padding: 20px 24px; border-radius: 12px 12px 0 0; position: relative;">
                <button onclick="closeMyScheduleModal()" style="position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; transition: background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                    <i class="fas fa-times"></i>
                </button>
                <h2 style="margin: 0; font-size: 1.8rem;">My Teaching Schedule</h2>
                <p style="margin: 8px 0 0 0; opacity: 0.9;">Manage your weekly teaching schedule</p>
            </div>
            
            <!-- Navigation Buttons -->
            <div style="padding: 16px 24px; background: #f8f9fa; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center;">
                <button onclick="mySchedulePreviousWeek()" style="background: var(--tutor-primary); color: white; border: none; border-radius: 8px; padding: 8px 16px; cursor: pointer; font-size: 0.9rem; display: flex; align-items: center; gap: 8px;" onmouseover="this.style.background='#1976d2'" onmouseout="this.style.background='var(--tutor-primary)'">
                    <i class="fas fa-chevron-left"></i> Previous Week
                </button>
                <div style="font-weight: 600; color: #333; font-size: 1.1rem;" id="scheduleWeekRange">
                    Week of January 15, 2024
                </div>
                <button onclick="myScheduleNextWeek()" style="background: var(--tutor-primary); color: white; border: none; border-radius: 8px; padding: 8px 16px; cursor: pointer; font-size: 0.9rem; display: flex; align-items: center; gap: 8px;" onmouseover="this.style.background='#1976d2'" onmouseout="this.style.background='var(--tutor-primary)'">
                    Next Week <i class="fas fa-chevron-right"></i>
                </button>
            </div>
            
            <!-- Modal Content -->
            <div style="display: flex; height: calc(90vh - 140px);">
                <!-- Left Panel - Weekly Calendar -->
                <div style="flex: 1; padding: 24px; border-right: 1px solid #e0e0e0; overflow-y: auto;">
                    <h3 style="color: var(--tutor-primary); margin-bottom: 20px; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-calendar-week"></i>
                        Weekly Schedule
                    </h3>
                    <div id="weeklyCalendarContainer" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 12px;">
                        <!-- Calendar will be generated here -->
                    </div>
                </div>
                
                <!-- Right Panel - Upcoming Lessons -->
                <div style="flex: 1; padding: 24px; overflow-y: auto;">
                    <h3 style="color: var(--tutor-primary); margin-bottom: 20px; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-clock"></i>
                        Upcoming Lessons
                    </h3>
                    <div id="upcomingLessonsContainer">
                        <!-- Lessons will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div id="profileModal" style="display: none; position: fixed; z-index: 10007; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); align-items: center; justify-content: center;">
        <div class="modal-content" style="width: 90%; max-width: 1000px; max-height: 90vh; background: white; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); position: relative; display: flex; flex-direction: column;" onclick="event.stopPropagation();">
            <!-- Profile Header -->
            <div style="background: linear-gradient(135deg, var(--tutor-primary), #1976d2); color: white; padding: 20px 24px; border-radius: 12px 12px 0 0; position: relative;">
                <button onclick="closeProfileModal()" style="position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; transition: background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                    <i class="fas fa-times"></i>
                </button>
                <div style="display: flex; align-items: center; gap: 20px;">
                    <div style="width: 80px; height: 80px; background: #4caf50; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2rem; color: white;">
                        <i class="fas fa-graduation-cap"></i>
                    </div>
                    <div>
                        <h2 id="profileTutorName" style="margin: 0; font-size: 1.8rem;">Dr. Sarah Johnson</h2>
                        <div style="font-size: 1rem; opacity: 0.9; margin-bottom: 4px;">American</div>
                        <div style="font-size: 0.9rem; opacity: 0.8; display: flex; align-items: center; gap: 16px;">
                            <span style="display: flex; align-items: center; gap: 4px;">
                                <i class="fas fa-star" style="color: #ffc107;"></i>
                                4.9 (98% positive)
                            </span>
                            <span style="display: flex; align-items: center; gap: 4px;">
                                <i class="fas fa-users"></i>
                                1.2K students
                            </span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Information Tags -->
            <div style="padding: 16px 24px; background: #f8f9fa; border-bottom: 1px solid #e0e0e0;">
                <div style="display: flex; flex-wrap: wrap; gap: 12px;">
                    <div style="background: #e9ecef; padding: 8px 12px; border-radius: 6px; font-size: 0.9rem; display: flex; align-items: center; gap: 6px;">
                        <i class="fas fa-list"></i>
                        <span>Teaches: <span id="profileTeaches">Intermediate | Upper Intermediate | Advanced</span></span>
                    </div>
                    <div style="background: #e9ecef; padding: 8px 12px; border-radius: 6px; font-size: 0.9rem; display: flex; align-items: center; gap: 6px;">
                        <i class="fas fa-star" style="color: #007bff;"></i>
                        <span>Test familiarity: <span id="profileTests">SAT, ACT, AP Calculus</span></span>
                    </div>
                    <div style="background: #e9ecef; padding: 8px 12px; border-radius: 6px; font-size: 0.9rem; display: flex; align-items: center; gap: 6px;">
                        <i class="fas fa-briefcase"></i>
                        <span>Industry familiarity: <span id="profileIndustry">Education, Research</span></span>
                    </div>
                </div>
            </div>
            
            <!-- Navigation Tabs -->
            <div style="padding: 0 24px; background: white; border-bottom: 1px solid #e0e0e0;">
                <div style="display: flex; gap: 32px;">
                    <button onclick="switchTab('about')" id="tabAbout" class="profile-tab active" style="padding: 16px 0; border: none; background: none; font-size: 1rem; font-weight: 600; color: var(--tutor-primary); border-bottom: 3px solid var(--tutor-primary); cursor: pointer;">
                        About
                    </button>
                    <button onclick="switchTab('reviews')" id="tabReviews" class="profile-tab" style="padding: 16px 0; border: none; background: none; font-size: 1rem; font-weight: 500; color: #666; border-bottom: 3px solid transparent; cursor: pointer;">
                        Reviews
                    </button>
                    <button onclick="switchTab('specialties')" id="tabSpecialties" class="profile-tab" style="padding: 16px 0; border: none; background: none; font-size: 1rem; font-weight: 500; color: #666; border-bottom: 3px solid transparent; cursor: pointer;">
                        Specialties
                    </button>
                    <button onclick="switchTab('experience')" id="tabExperience" class="profile-tab" style="padding: 16px 0; border: none; background: none; font-size: 1rem; font-weight: 500; color: #666; border-bottom: 3px solid transparent; cursor: pointer;">
                        Experience
                    </button>
                </div>
            </div>
            
            <!-- Tab Content -->
            <div style="padding: 24px; overflow-y: auto; flex: 1; min-height: 0;">
                <!-- About Tab -->
                <div id="tabContentAbout" class="tab-content active">
                    <div style="margin-bottom: 24px;">
                        <h3 style="color: #333; margin-bottom: 16px;">Hello!</h3>
                        <div style="margin-bottom: 16px;">
                            <textarea id="profileIntroduction" rows="4" style="width: 100%; padding: 12px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 1rem; resize: vertical; font-family: inherit;">I'm from the United States and have been teaching mathematics and physics for eight years. I'm passionate about simplifying complex concepts and helping students understand real-world applications. My teaching style focuses on building strong foundations and developing problem-solving skills.</textarea>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 24px;">
                        <h3 style="color: #333; margin-bottom: 16px;">Student Preferences</h3>
                        <input type="text" id="prefOpenToNew" value="Open to new students" style="width: 100%; padding: 12px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 1rem; background: white;">
                    </div>
                    
                    <div style="margin-bottom: 24px;">
                        <h3 style="color: #333; margin-bottom: 16px;">Languages</h3>
                        <input type="text" id="langEnglish" value="English (Native)" style="width: 100%; padding: 12px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 1rem; background: white; margin-bottom: 8px;">
                        <input type="text" id="langSpanish" value="Spanish (Conversational)" style="width: 100%; padding: 12px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 1rem; background: white;">
                    </div>
                    
                    <div style="margin-bottom: 24px;">
                        <h3 style="color: #333; margin-bottom: 16px;">Industry Familiarity</h3>
                        <input type="text" id="indEducation" value="Education" style="width: 100%; padding: 12px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 1rem; background: white; margin-bottom: 8px;">
                        <input type="text" id="indResearch" value="Research" style="width: 100%; padding: 12px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 1rem; background: white;">
                    </div>
                </div>
                
                <!-- Reviews Tab -->
                <div id="tabContentReviews" class="tab-content" style="display: none;">
                    <h3 style="color: #333; margin-bottom: 16px;">Student Reviews</h3>
                    <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 24px;">
                        <div style="font-size: 3rem; font-weight: 700; color: var(--tutor-primary);">4.9</div>
                        <div>
                            <div style="display: flex; gap: 4px; margin-bottom: 8px;">
                                <i class="fas fa-star" style="color: #ffc107;"></i>
                                <i class="fas fa-star" style="color: #ffc107;"></i>
                                <i class="fas fa-star" style="color: #ffc107;"></i>
                                <i class="fas fa-star" style="color: #ffc107;"></i>
                                <i class="fas fa-star" style="color: #ffc107;"></i>
                            </div>
                            <div style="color: #666; font-size: 0.9rem;">Based on 1,247 reviews</div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 16px;">
                        <div style="background: white; border: 1px solid #e0e0e0; border-radius: 8px; padding: 16px; margin-bottom: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                                <div style="font-weight: 600; color: #333;">Excellent teacher!</div>
                                <div style="display: flex; gap: 2px;">
                                    <i class="fas fa-star" style="color: #ffc107; font-size: 0.8rem;"></i>
                                    <i class="fas fa-star" style="color: #ffc107; font-size: 0.8rem;"></i>
                                    <i class="fas fa-star" style="color: #ffc107; font-size: 0.8rem;"></i>
                                    <i class="fas fa-star" style="color: #ffc107; font-size: 0.8rem;"></i>
                                    <i class="fas fa-star" style="color: #ffc107; font-size: 0.8rem;"></i>
                                </div>
                            </div>
                            <div style="color: #666; font-size: 0.9rem; margin-bottom: 8px;">Dr. Johnson made calculus so much easier to understand. Her explanations are clear and she's very patient.</div>
                            <div style="color: #999; font-size: 0.8rem;">- Nguyen Van A, 2 days ago</div>
                        </div>
                        
                        <div style="background: white; border: 1px solid #e0e0e0; border-radius: 8px; padding: 16px; margin-bottom: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                                <div style="font-weight: 600; color: #333;">Great physics tutor</div>
                                <div style="display: flex; gap: 2px;">
                                    <i class="fas fa-star" style="color: #ffc107; font-size: 0.8rem;"></i>
                                    <i class="fas fa-star" style="color: #ffc107; font-size: 0.8rem;"></i>
                                    <i class="fas fa-star" style="color: #ffc107; font-size: 0.8rem;"></i>
                                    <i class="fas fa-star" style="color: #ffc107; font-size: 0.8rem;"></i>
                                    <i class="fas fa-star" style="color: #ffc107; font-size: 0.8rem;"></i>
                                </div>
                            </div>
                            <div style="color: #666; font-size: 0.9rem; margin-bottom: 8px;">Very knowledgeable and explains complex topics in simple terms. Highly recommend!</div>
                            <div style="color: #999; font-size: 0.8rem;">- Le Thi B, 1 week ago</div>
                        </div>
                    </div>
                </div>
                
                <!-- Specialties Tab -->
                <div id="tabContentSpecialties" class="tab-content" style="display: none;">
                    <h3 style="color: #333; margin-bottom: 16px;">Teaching Specialties</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px;">
                        <div style="background: #f8f9fa; border: 1px solid #e0e0e0; border-radius: 8px; padding: 16px;">
                            <h4 style="color: var(--tutor-primary); margin-bottom: 8px;">Mathematics</h4>
                            <ul style="margin: 0; padding-left: 20px; color: #666;">
                                <li>Calculus (AP, College)</li>
                                <li>Linear Algebra</li>
                                <li>Statistics</li>
                                <li>Trigonometry</li>
                            </ul>
                        </div>
                        <div style="background: #f8f9fa; border: 1px solid #e0e0e0; border-radius: 8px; padding: 16px;">
                            <h4 style="color: var(--tutor-primary); margin-bottom: 8px;">Physics</h4>
                            <ul style="margin: 0; padding-left: 20px; color: #666;">
                                <li>Mechanics</li>
                                <li>Electromagnetism</li>
                                <li>Thermodynamics</li>
                                <li>Quantum Physics</li>
                            </ul>
                        </div>
                        <div style="background: #f8f9fa; border: 1px solid #e0e0e0; border-radius: 8px; padding: 16px;">
                            <h4 style="color: var(--tutor-primary); margin-bottom: 8px;">Test Preparation</h4>
                            <ul style="margin: 0; padding-left: 20px; color: #666;">
                                <li>SAT Mathematics</li>
                                <li>ACT Science</li>
                                <li>AP Calculus AB/BC</li>
                                <li>AP Physics</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <!-- Experience Tab -->
                <div id="tabContentExperience" class="tab-content" style="display: none;">
                    <h3 style="color: #333; margin-bottom: 16px;">Professional Experience</h3>
                    <div style="display: flex; flex-direction: column; gap: 16px;">
                        <div style="border-left: 3px solid var(--tutor-primary); padding-left: 16px;">
                            <h4 style="color: var(--tutor-primary); margin-bottom: 4px;">Senior Mathematics Instructor</h4>
                            <div style="color: #666; font-size: 0.9rem; margin-bottom: 4px;">Stanford University â€¢ 2019 - Present</div>
                            <div style="color: #666; font-size: 0.9rem;">Teaching advanced mathematics courses and mentoring graduate students</div>
                        </div>
                        <div style="border-left: 3px solid var(--tutor-primary); padding-left: 16px;">
                            <h4 style="color: var(--tutor-primary); margin-bottom: 4px;">Physics Professor</h4>
                            <div style="color: #666; font-size: 0.9rem; margin-bottom: 4px;">MIT â€¢ 2016 - 2019</div>
                            <div style="color: #666; font-size: 0.9rem;">Conducted research in quantum mechanics and taught undergraduate physics</div>
                        </div>
                        <div style="border-left: 3px solid var(--tutor-primary); padding-left: 16px;">
                            <h4 style="color: var(--tutor-primary); margin-bottom: 4px;">Mathematics Teacher</h4>
                            <div style="color: #666; font-size: 0.9rem; margin-bottom: 4px;">Harvard University â€¢ 2014 - 2016</div>
                            <div style="color: #666; font-size: 0.9rem;">Taught calculus and linear algebra to undergraduate students</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div id="profileActionButtons" style="padding: 20px 24px; background: #f8f9fa; border-top: 1px solid #e0e0e0; display: flex !important; gap: 12px; justify-content: flex-end; visibility: visible !important; opacity: 1 !important; min-height: 60px; flex-shrink: 0;">
                <button onclick="closeProfileModal()" style="background: #6c757d; color: white; border: none; border-radius: 8px; padding: 12px 24px; font-size: 1rem; cursor: pointer; transition: background 0.2s; min-width: 80px;" onmouseover="this.style.background='#5a6268'" onmouseout="this.style.background='#6c757d'">
                    Cancel
                </button>
                <button onclick="saveProfileChanges()" style="background: var(--tutor-primary); color: white; border: none; border-radius: 8px; padding: 12px 24px; font-size: 1rem; cursor: pointer; transition: background 0.2s; min-width: 120px;" onmouseover="this.style.background='#1976d2'" onmouseout="this.style.background='var(--tutor-primary)'">
                    <i class="fas fa-save"></i> Save Changes
                </button>
            </div>
        </div>
    </div>

    <!-- Create Lesson Modal -->
    <div id="createLessonModal" style="display: none; position: fixed; z-index: 10008; left: 0; top: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.5); align-items: center; justify-content: center;" onclick="closeCreateLessonModal()">
        <div style="width: 90%; max-width: 800px; max-height: 90vh; overflow: hidden; background: white; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); position: relative;" onclick="event.stopPropagation();">
            <!-- Modal Header -->
            <div style="background: linear-gradient(135deg, var(--tutor-primary), #1976d2); color: white; padding: 20px 24px; border-radius: 12px 12px 0 0; position: relative;">
                <button onclick="closeCreateLessonModal()" style="position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; transition: background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                    <i class="fas fa-times"></i>
                </button>
                <h2 style="margin: 0; font-size: 1.8rem;">Create New Lesson</h2>
                <p style="margin: 8px 0 0 0; opacity: 0.9;">Set up your teaching availability</p>
            </div>
            
            <!-- Modal Content -->
            <div style="padding: 24px; overflow-y: auto; max-height: calc(90vh - 140px);">
                <!-- Lesson Form -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px;">
                    <div>
                        <label style="font-weight: 500; display: block; margin-bottom: 8px;">Subject: <span style="color:#ff0000;">*</span></label>
                        <select id="singleSubject" style="width: 100%; padding: 12px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 1rem;">
                            <option value="">Select Subject</option>
                            <option value="Mathematics">Mathematics</option>
                            <option value="Physics">Physics</option>
                            <option value="Chemistry">Chemistry</option>
                            <option value="Computer Science">Computer Science</option>
                            <option value="English">English</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-weight: 500; display: block; margin-bottom: 8px;">Date: <span style="color:#ff0000;">*</span></label>
                        <input type="date" id="singleDate" style="width: 100%; padding: 12px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 1rem;">
                    </div>
                    <div>
                        <label style="font-weight: 500; display: block; margin-bottom: 8px;">Start Time: <span style="color:#ff0000;">*</span></label>
                        <input type="time" id="singleStartTime" style="width: 100%; padding: 12px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 1rem;">
                    </div>
                    <div>
                        <label style="font-weight: 500; display: block; margin-bottom: 8px;">Duration: <span style="color:#ff0000;">*</span></label>
                        <select id="singleDuration" style="width: 100%; padding: 12px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 1rem;">
                            <option value="30">30 minutes</option>
                            <option value="60" selected>60 minutes</option>
                            <option value="90">90 minutes</option>
                            <option value="120">120 minutes</option>
                        </select>
                    </div>
                </div>
                <div style="margin-bottom: 24px;">
                    <label style="font-weight: 500; display: block; margin-bottom: 8px;">Description:</label>
                    <textarea id="singleDescription" rows="3" placeholder="What will be covered in this lesson?" style="width: 100%; padding: 12px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 1rem; resize: vertical;"></textarea>
                </div>
                
                <!-- Preview Section -->
                <div style="background: #f8f9fa; border: 1px solid #e0e0e0; border-radius: 8px; padding: 16px; margin-bottom: 24px;">
                    <h4 style="color: var(--tutor-primary); margin-bottom: 12px;">Lesson Preview</h4>
                    <div id="lessonPreview" style="color: #666; font-size: 0.9rem;">
                        Fill in the form above to see a preview of your lesson
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div style="padding: 20px 24px; background: #f8f9fa; border-top: 1px solid #e0e0e0; display: flex; gap: 12px; justify-content: flex-end;">
                <button onclick="closeCreateLessonModal()" style="background: #6c757d; color: white; border: none; border-radius: 8px; padding: 12px 24px; font-size: 1rem; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='#5a6268'" onmouseout="this.style.background='#6c757d'">
                    Cancel
                </button>
                <button onclick="createLesson()" style="background: var(--tutor-primary); color: white; border: none; border-radius: 8px; padding: 12px 24px; font-size: 1rem; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='#1976d2'" onmouseout="this.style.background='var(--tutor-primary)'">
                    <i class="fas fa-plus"></i> Create Lesson
                </button>
            </div>
        </div>
    </div>

    <!-- Reschedule Modal -->
    <div id="rescheduleModal" style="display: none; position: fixed; z-index: 10009; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); align-items: center; justify-content: center;">
        <div style="width: 90%; max-width: 600px; max-height: 90vh; overflow: hidden; background: white; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); position: relative;" onclick="event.stopPropagation();">
            <!-- Reschedule Header -->
            <div style="background: linear-gradient(135deg, #ff9800, #f57c00); color: white; padding: 20px 24px; border-radius: 12px 12px 0 0; position: relative;">
                <button onclick="closeRescheduleModal()" style="position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; transition: background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                    <i class="fas fa-times"></i>
                </button>
                
                <div style="display: flex; align-items: center; gap: 16px;">
                    <i class="fas fa-clock" style="font-size: 1.5rem;"></i>
                    <div>
                        <h2 id="rescheduleTitle" style="margin: 0; font-size: 1.6rem;">Reschedule Lesson</h2>
                        <div id="rescheduleCurrentInfo" style="font-size: 0.9rem; opacity: 0.9;">Current: Loading...</div>
                    </div>
                </div>
            </div>
            
            <!-- Reschedule Content -->
            <div style="padding: 24px;">
                <div style="margin-bottom: 24px;">
                    <h3 style="color: #333; margin-bottom: 16px;">Select New Time</h3>
                    <div id="rescheduleCalendar" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin-bottom: 16px;">
                        <!-- Calendar will be generated here -->
                    </div>
                    <div id="rescheduleTimeSlots" style="display: flex; flex-wrap: wrap; gap: 8px;">
                        <!-- Time slots will be generated here -->
                    </div>
                    
                    <!-- Selected Time Display -->
                    <div id="selectedTimeDisplay" style="display: none; margin-top: 16px; padding: 12px; background: #e8f5e8; border: 1px solid #4caf50; border-radius: 8px; color: #2e7d32; font-weight: 600; text-align: center;">
                        <!-- Selected time will be displayed here -->
                    </div>
                </div>
                
                <div style="margin-bottom: 24px;">
                    <h3 style="color: #333; margin-bottom: 16px;">Reason for Reschedule</h3>
                    <textarea id="rescheduleReason" placeholder="Please explain why you need to reschedule this lesson..." style="width: 100%; min-height: 100px; padding: 12px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 1rem; resize: vertical;"></textarea>
                </div>
                
                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                    <button onclick="closeRescheduleModal()" style="background: #6c757d; color: white; border: none; border-radius: 8px; padding: 12px 24px; font-size: 1rem; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='#5a6268'" onmouseout="this.style.background='#6c757d'">
                        Cancel
                    </button>
                    <button onclick="submitRescheduleRequest()" style="background: #ff9800; color: white; border: none; border-radius: 8px; padding: 12px 24px; font-size: 1rem; font-weight: 500; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='#f57c00'" onmouseout="this.style.background='#ff9800'">
                        <i class="fas fa-paper-plane"></i> Send Request to Student
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentRequest = null;
        

        
        // Define utility functions first
        function closeAllModals() {
            console.log('Closing all modals...');
            const allModals = [
                'requestDetailModal',
                'myScheduleModal', 
                'profileModal',
                'createLessonModal',
                'rescheduleModal'
            ];
            
            allModals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (modal) {
                    console.log(`Closing modal: ${modalId}`);
                    modal.style.display = 'none';
                }
            });
            
            // Double-check that all modals are closed
            setTimeout(() => {
                const openModals = allModals.filter(modalId => {
                    const modal = document.getElementById(modalId);
                    return modal && modal.style.display === 'flex';
                });
                
                if (openModals.length > 0) {
                    console.warn('Some modals are still open:', openModals);
                    openModals.forEach(modalId => {
                        const modal = document.getElementById(modalId);
                        if (modal) {
                            modal.style.display = 'none';
                        }
                    });
                } else {
                    console.log('All modals successfully closed');
                }
            }, 100);
        }
        
        function isAnyModalOpen() {
            const allModals = [
                'requestDetailModal',
                'myScheduleModal', 
                'profileModal',
                'createLessonModal',
                'rescheduleModal'
            ];
            
            return allModals.some(modalId => {
                const modal = document.getElementById(modalId);
                return modal && modal.style.display === 'flex';
            });
        }
        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Tutor dashboard initializing...');
            
            // Clear any URL parameters or hash that might cause issues
            if (window.location.hash) {
                console.log('Clearing URL hash:', window.location.hash);
                window.location.hash = '';
            }
            
            // Ensure we're on the dashboard view
            showDashboardView();
            
            // Load dashboard data
            loadRescheduleRequests();
            initializeCharts();
            
            // Test all functionality (but don't open any modals)
            testAllFunctionality();
            
            // Add ESC key listener
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    closeAllModals();
                }
            });
            
            console.log('Tutor dashboard initialized successfully');
        });
        
        // Handle page visibility changes (for when user returns to tab)
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                console.log('Page became visible');
            }
        });
        
        // Handle beforeunload to ensure clean state
        window.addEventListener('beforeunload', function() {
            console.log('Page unloading, cleaning up...');
        });
        
        // Additional check on window load to ensure proper initialization
        window.addEventListener('load', function() {
            console.log('Window fully loaded');
        });
        
        // Test profile functionality
        function testProfileFunctionality() {
            console.log('Testing profile functionality...');
            
            // Test if profile modal exists
            const profileModal = document.getElementById('profileModal');
            if (!profileModal) {
                console.error('Profile modal not found!');
                return false;
            }
            
            // Test if all profile elements exist
            const requiredElements = [
                'profileIntroduction',
                'prefOpenToNew',
                'langEnglish',
                'langSpanish',
                'indEducation',
                'indResearch',
                'tabAbout',
                'tabReviews',
                'tabSpecialties',
                'tabExperience'
            ];
            
            const missingElements = [];
            requiredElements.forEach(elementId => {
                if (!document.getElementById(elementId)) {
                    missingElements.push(elementId);
                }
            });
            
            if (missingElements.length > 0) {
                console.error('Missing profile elements:', missingElements);
                return false;
            }
            
            console.log('Profile functionality test passed');
            return true;
        }
        
        // Test all functionality
        function testAllFunctionality() {
            console.log('Testing all functionality...');
            
            const tests = [
                { name: 'Profile', test: testProfileFunctionality },
                { name: 'Reschedule Requests', test: () => {
                    const table = document.getElementById('rescheduleRequestsTable');
                    return table !== null;
                }},
                { name: 'My Schedule Modal', test: () => {
                    const modal = document.getElementById('myScheduleModal');
                    return modal !== null;
                }},
                { name: 'Create Lesson Modal', test: () => {
                    const modal = document.getElementById('createLessonModal');
                    return modal !== null;
                }},
                { name: 'Charts', test: () => {
                    const weeklyChart = document.getElementById('weeklyScheduleChart');
                    const performanceChart = document.getElementById('studentPerformanceChart');
                    return weeklyChart !== null && performanceChart !== null;
                }}
            ];
            
            let allPassed = true;
            tests.forEach(test => {
                const result = test.test();
                if (result) {
                    console.log(`âœ… ${test.name} test passed`);
                } else {
                    console.error(`âŒ ${test.name} test failed`);
                    allPassed = false;
                }
            });
            
            if (allPassed) {
                console.log('ðŸŽ‰ All functionality tests passed!');
            } else {
                console.error('âš ï¸ Some functionality tests failed');
            }
            
            return allPassed;
        }
        
        // Prevent any unwanted redirects and modal openings
        let redirectPrevented = false;
        const originalLocationHref = window.location.href;
        let pageFullyLoaded = false;
        
        // Set page as fully loaded after a delay
        setTimeout(() => {
            pageFullyLoaded = true;
            console.log('Page marked as fully loaded');
        }, 2000);
        
        // Monitor for any location changes - TEMPORARILY DISABLED
        /*
        setInterval(function() {
            if (window.location.href !== originalLocationHref && !redirectPrevented) {
                console.log('Unexpected location change detected, preventing...');
                redirectPrevented = true;
                // Only allow redirects to lesson.html when explicitly called
                if (!window.location.href.includes('lesson.html')) {
                    window.location.href = originalLocationHref;
                }
            }
        }, 1000);
        */
        
        // Track user interaction to prevent auto-closing modals during page load
        window.userInteracting = false;
        
        function setUserInteracting() {
            console.log('Setting user interaction flag - modal opened by user');
            window.userInteracting = true;
        }
        
        // Monitor for unwanted modal openings (debugging only) - TEMPORARILY DISABLED
        /*
        setInterval(function() {
            if (!pageFullyLoaded) return;
            
            const openModals = ['requestDetailModal', 'myScheduleModal', 'profileModal', 'createLessonModal'].filter(modalId => {
                const modal = document.getElementById(modalId);
                return modal && modal.style.display === 'flex';
            });
            
            if (openModals.length > 0) {
                console.log(`Monitoring: ${openModals.length} modal(s) open:`, openModals);
                console.log(`User interacting: ${window.userInteracting}`);
                
                if (!window.userInteracting) {
                    console.warn('Unexpected modal(s) open without user interaction:', openModals);
                }
            }
        }, 2000); // Check every 2 seconds for debugging
        */
        
                // Function to ensure dashboard view is shown (initial load only)
        function showDashboardView() {
            console.log('Ensuring dashboard view is displayed...');
            
            // Force close ALL modals to ensure clean state (only called during initial load)
            const allModals = [
                'requestDetailModal',
                'myScheduleModal', 
                'profileModal',
                'createLessonModal',
                'rescheduleModal'
            ];
            
            allModals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (modal) {
                    console.log(`Closing modal: ${modalId}`);
                    modal.style.display = 'none';
                }
            });
            
            // Ensure dashboard content is visible
            const dashboardContent = document.querySelector('.content');
            if (dashboardContent) {
                dashboardContent.style.display = 'block';
            }
            
            // Set dashboard nav item as active
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => item.classList.remove('active'));
            
            const dashboardNav = document.querySelector('.nav-item:first-child');
            if (dashboardNav) {
                dashboardNav.classList.add('active');
            }
            
            // Clear any URL fragments or parameters that might cause issues
            if (window.location.hash) {
                window.location.hash = '';
            }
            
            console.log('Dashboard view ensured');
        }
        
        // Function to set dashboard nav as active (without closing modals)
        function setDashboardActive() {
            console.log('Setting dashboard nav as active...');
            
            // Set dashboard nav item as active
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => item.classList.remove('active'));
            
            const dashboardNav = document.querySelector('.nav-item:first-child');
            if (dashboardNav) {
                dashboardNav.classList.add('active');
            }
            
            console.log('Dashboard nav set as active');
        }
        
        function loadRescheduleRequests() {
            try {
                const requests = JSON.parse(localStorage.getItem('tutorPendingRequests') || '[]');
                const tableBody = document.getElementById('rescheduleRequestsTable');
                
                if (requests.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="4" style="text-align: center; padding: 40px; color: #666; font-style: italic;">
                                No pending reschedule requests
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                tableBody.innerHTML = '';
                
                requests.forEach((request, index) => {
                    const requestDate = new Date(request.createdAt);
                    const timeAgo = getTimeAgo(requestDate);
                    
                    const row = document.createElement('tr');
                    row.style.cssText = index % 2 === 0 ? 'background-color: #f8f9fa;' : 'background-color: white;';
                    
                    row.innerHTML = `
                        <td style="padding: 12px; font-weight: 500;">${request.studentName}</td>
                        <td style="padding: 12px;">${getSubjectFromLesson(request.lessonId)}</td>
                        <td style="padding: 12px; color: #666;">${timeAgo}</td>
                        <td style="padding: 12px;">
                            <button onclick="viewRequestDetails('${request.id}')" style="background: #007bff; color: white; border: none; border-radius: 4px; padding: 6px 12px; font-size: 0.9rem; cursor: pointer; margin-right: 8px;">
                                View
                            </button>
                        </td>
                    `;
                    
                    tableBody.appendChild(row);
                });
                
            } catch (error) {
                console.error('Error loading reschedule requests:', error);
            }
        }
        
        function getSubjectFromLesson(lessonId) {
            // Demo subjects - in real app this would come from lesson data
            const subjects = ['Mathematics', 'Physics', 'Chemistry', 'English', 'Computer Science'];
            return subjects[Math.floor(Math.random() * subjects.length)];
        }
        
        function getTimeAgo(date) {
            const now = new Date();
            const diffInHours = Math.floor((now - date) / (1000 * 60 * 60));
            
            if (diffInHours < 1) return 'Just now';
            if (diffInHours < 24) return `${diffInHours} hours ago`;
            if (diffInHours < 48) return 'Yesterday';
            return `${Math.floor(diffInHours / 24)} days ago`;
        }
        
        function viewRequestDetails(requestId) {
            setUserInteracting(); // Set user interaction flag
            try {
                const requests = JSON.parse(localStorage.getItem('tutorPendingRequests') || '[]');
                const request = requests.find(r => r.id === requestId);
                
                if (!request) {
                    alert('Request not found');
                    return;
                }
                
                currentRequest = request;
                
                // Update modal title
                document.getElementById('modalTitle').textContent = `Reschedule Request from ${request.studentName}`;
                document.getElementById('modalSubtitle').textContent = `Requested on ${new Date(request.createdAt).toLocaleDateString()}`;
                
                // Load request details
                const detailsDiv = document.getElementById('requestDetails');
                detailsDiv.innerHTML = `
                    <div style="margin-bottom: 24px;">
                        <h3 style="color: #333; margin-bottom: 16px;">Current Lesson</h3>
                        <div style="background: #f8f9fa; padding: 16px; border-radius: 8px; border-left: 4px solid #007bff;">
                            <div style="font-weight: 600; color: #333;">${request.currentDateTime}</div>
                            <div style="color: #666; font-size: 0.9rem;">Current scheduled time</div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 24px;">
                        <h3 style="color: #333; margin-bottom: 16px;">Requested Change</h3>
                        <div style="background: #e8f5e8; padding: 16px; border-radius: 8px; border-left: 4px solid #28a745;">
                            <div style="font-weight: 600; color: #2e7d32;">${request.requestedDateTime}</div>
                            <div style="color: #666; font-size: 0.9rem;">Student's preferred time</div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 24px;">
                        <h3 style="color: #333; margin-bottom: 16px;">Reason for Reschedule</h3>
                        <div style="background: #fff3e0; padding: 16px; border-radius: 8px; border-left: 4px solid #ff9800;">
                            <div style="color: #333; line-height: 1.5;">${request.reason}</div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 24px;">
                        <h3 style="color: #333; margin-bottom: 16px;">Student Information</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div>
                                <label style="font-weight: 600; color: #666; font-size: 0.9rem;">Student Name</label>
                                <div style="padding: 8px; background: #f8f9fa; border-radius: 4px;">${request.studentName}</div>
                            </div>
                            <div>
                                <label style="font-weight: 600; color: #666; font-size: 0.9rem;">Student ID</label>
                                <div style="padding: 8px; background: #f8f9fa; border-radius: 4px;">${request.studentId}</div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Show modal
                document.getElementById('requestDetailModal').style.display = 'flex';
                
            } catch (error) {
                console.error('Error viewing request details:', error);
                alert('Error loading request details: ' + error.message);
            }
        }
        
        function closeRequestDetailModal() {
            document.getElementById('requestDetailModal').style.display = 'none';
            currentRequest = null;
        }
        
        function approveRequest() {
            if (!currentRequest) {
                alert('No request selected');
                return;
            }
            
            try {
                // Update request status
                currentRequest.status = 'approved';
                currentRequest.respondedAt = new Date().toISOString();
                
                // Update localStorage
                updateRequestStatus(currentRequest);
                
                // Show success message
                alert(`âœ… Request approved! The lesson has been rescheduled to ${currentRequest.requestedDateTime}`);
                
                // Close modal and refresh
                closeRequestDetailModal();
                loadRescheduleRequests();
                
            } catch (error) {
                console.error('Error approving request:', error);
                alert('Error approving request: ' + error.message);
            }
        }
        
        function rejectRequest() {
            if (!currentRequest) {
                alert('No request selected');
                return;
            }
            
            const reason = prompt('Please provide a reason for rejection:');
            if (!reason) return;
            
            try {
                // Update request status
                currentRequest.status = 'rejected';
                currentRequest.rejectionReason = reason;
                currentRequest.respondedAt = new Date().toISOString();
                
                // Update localStorage
                updateRequestStatus(currentRequest);
                
                // Show success message
                alert(`âŒ Request rejected. Student will be notified.`);
                
                // Close modal and refresh
                closeRequestDetailModal();
                loadRescheduleRequests();
                
            } catch (error) {
                console.error('Error rejecting request:', error);
                alert('Error rejecting request: ' + error.message);
            }
        }
        
        function updateRequestStatus(updatedRequest) {
            try {
                // Update in tutor pending requests
                const tutorRequests = JSON.parse(localStorage.getItem('tutorPendingRequests') || '[]');
                const updatedTutorRequests = tutorRequests.filter(r => r.id !== updatedRequest.id);
                localStorage.setItem('tutorPendingRequests', JSON.stringify(updatedTutorRequests));
                
                // Update in learner reschedule requests
                const learnerRequests = JSON.parse(localStorage.getItem('rescheduleRequests') || '[]');
                const updatedLearnerRequests = learnerRequests.map(r => 
                    r.id === updatedRequest.id ? updatedRequest : r
                );
                localStorage.setItem('rescheduleRequests', JSON.stringify(updatedLearnerRequests));
                
                console.log('Request status updated:', updatedRequest);
                
            } catch (error) {
                console.error('Error updating request status:', error);
            }
        }
        
        function refreshRequests() {
            console.log('Refreshing reschedule requests...');
            loadRescheduleRequests();
            
            // Show success message
            const refreshBtn = document.querySelector('button[onclick="refreshRequests()"]');
            if (refreshBtn) {
                const originalText = refreshBtn.innerHTML;
                refreshBtn.innerHTML = '<i class="fas fa-check"></i> Refreshed';
                refreshBtn.style.background = '#28a745';
                
                setTimeout(() => {
                    refreshBtn.innerHTML = originalText;
                    refreshBtn.style.background = '';
                }, 2000);
            }
        }
        
        function showRescheduleRequests() {
            console.log('Showing reschedule requests...');
            // This would navigate to a dedicated reschedule requests page
            // For now, just refresh the current view
            loadRescheduleRequests();
            
            // Ensure dashboard content is visible
            const dashboardContent = document.querySelector('.content');
            if (dashboardContent) {
                dashboardContent.style.display = 'block';
            }
            
            // Set reschedule requests nav item as active
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => item.classList.remove('active'));
            
            const rescheduleNav = document.querySelector('.nav-item:nth-child(2)');
            if (rescheduleNav) {
                rescheduleNav.classList.add('active');
            }
        }
        
        // My Schedule Functions
        let currentWeekOffset = 0;
        
        function showMyScheduleModal() {
            console.log('Opening my schedule modal...');
            setUserInteracting(); // Set user interaction flag
            const modal = document.getElementById('myScheduleModal');
            if (modal) {
            modal.style.display = 'flex';
            initializeMyScheduleCalendar();
            loadUpcomingLessons();
            } else {
                console.error('My schedule modal not found!');
            }
        }
        
        function closeMyScheduleModal() {
            console.log('Closing my schedule modal...');
            const modal = document.getElementById('myScheduleModal');
            if (modal) {
            modal.style.display = 'none';
            } else {
                console.error('My schedule modal not found!');
            }
        }
        
        function initializeMyScheduleCalendar() {
            renderMyScheduleWeekCalendar();
            updateWeekRange();
        }
        
        function renderMyScheduleWeekCalendar() {
            const container = document.getElementById('weeklyCalendarContainer');
            const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            
            container.innerHTML = '';
            
            days.forEach((day, index) => {
                const dayElement = document.createElement('div');
                dayElement.style.cssText = `
                    background: white;
                    border: 1px solid #e0e0e0;
                    border-radius: 8px;
                    padding: 16px;
                    min-height: 120px;
                    display: flex;
                    flex-direction: column;
                `;
                
                // Calculate the actual date for this day
                const today = new Date();
                const monday = new Date(today);
                monday.setDate(today.getDate() - today.getDay() + 1 + (currentWeekOffset * 7));
                const dayDate = new Date(monday);
                dayDate.setDate(monday.getDate() + index);
                
                const dayName = dayDate.toLocaleDateString('en-US', { weekday: 'short' });
                const dayNumber = dayDate.getDate();
                const monthName = dayDate.toLocaleDateString('en-US', { month: 'short' });
                
                // Check if it's today
                const isToday = dayDate.toDateString() === today.toDateString();
                const isPast = dayDate < today;
                
                dayElement.innerHTML = `
                    <div style="text-align: center; margin-bottom: 12px;">
                        <div style="font-weight: 600; color: ${isToday ? 'var(--tutor-primary)' : '#333'}; font-size: 1rem;">
                            ${dayName}
                        </div>
                        <div style="font-size: 1.2rem; font-weight: 700; color: ${isToday ? 'var(--tutor-primary)' : '#666'};">
                            ${dayNumber}
                        </div>
                        <div style="font-size: 0.8rem; color: #999;">
                            ${monthName}
                        </div>
                    </div>
                    <div style="flex: 1; display: flex; flex-direction: column; gap: 4px;">
                        ${generateDemoLessons(dayName, dayDate)}
                    </div>
                `;
                
                container.appendChild(dayElement);
            });
        }
        
        function generateDemoLessons(dayName, dayDate) {
            // Demo lessons data for tutor
            const demoLessons = {
                'Mon': [
                    { time: '09:00', subject: 'Mathematics', student: 'Nguyen Van A', duration: '60min' },
                    { time: '14:00', subject: 'Physics', student: 'Le Thi B', duration: '60min' },
                    { time: '16:00', subject: 'Mathematics', student: 'Tran Van C', duration: '60min' }
                ],
                'Tue': [
                    { time: '10:00', subject: 'Computer Science', student: 'Pham Thi D', duration: '60min' },
                    { time: '15:00', subject: 'Physics', student: 'Hoang Van E', duration: '60min' }
                ],
                'Wed': [
                    { time: '11:00', subject: 'Mathematics', student: 'Nguyen Van A', duration: '60min' },
                    { time: '16:00', subject: 'Chemistry', student: 'Le Thi B', duration: '60min' }
                ],
                'Thu': [
                    { time: '09:00', subject: 'Physics', student: 'Tran Van C', duration: '60min' },
                    { time: '14:00', subject: 'Computer Science', student: 'Pham Thi D', duration: '60min' },
                    { time: '16:00', subject: 'Mathematics', student: 'Hoang Van E', duration: '60min' }
                ],
                'Fri': [
                    { time: '10:00', subject: 'Chemistry', student: 'Nguyen Van A', duration: '60min' },
                    { time: '15:00', subject: 'Physics', student: 'Le Thi B', duration: '60min' }
                ],
                'Sat': [
                    { time: '09:00', subject: 'Mathematics', student: 'Tran Van C', duration: '60min' }
                ],
                'Sun': []
            };
            
            const lessons = demoLessons[dayName] || [];
            
            if (lessons.length === 0) {
                return '<div style="text-align: center; color: #999; font-size: 0.8rem; margin-top: 20px;">No lessons</div>';
            }
            
            return lessons.map(lesson => `
                <div style="background: #e3f2fd; border: 1px solid var(--tutor-primary); border-radius: 4px; padding: 6px; font-size: 0.75rem;">
                    <div style="font-weight: 600; color: var(--tutor-primary);">${lesson.time}</div>
                    <div style="color: #333; font-size: 0.7rem;">${lesson.subject}</div>
                    <div style="color: #666; font-size: 0.65rem;">${lesson.student}</div>
                    <div style="color: #999; font-size: 0.6rem;">${lesson.duration}</div>
                </div>
            `).join('');
        }
        
        function loadUpcomingLessons() {
            const container = document.getElementById('upcomingLessonsContainer');
            
            // Demo upcoming lessons
            const upcomingLessons = [
                {
                    id: 'L001',
                    subject: 'Mathematics',
                    student: 'Nguyen Van A',
                    date: '2024-01-20',
                    time: '14:00',
                    duration: '60 minutes',
                    status: 'Scheduled'
                },
                {
                    id: 'L002',
                    subject: 'Physics',
                    student: 'Le Thi B',
                    date: '2024-01-21',
                    time: '10:00',
                    duration: '60 minutes',
                    status: 'Scheduled'
                },
                {
                    id: 'L003',
                    subject: 'Computer Science',
                    student: 'Tran Van C',
                    date: '2024-01-22',
                    time: '16:00',
                    duration: '60 minutes',
                    status: 'Scheduled'
                },
                {
                    id: 'L004',
                    subject: 'Chemistry',
                    student: 'Pham Thi D',
                    date: '2024-01-23',
                    time: '09:00',
                    duration: '60 minutes',
                    status: 'Scheduled'
                },
                {
                    id: 'L005',
                    subject: 'Mathematics',
                    student: 'Hoang Van E',
                    date: '2024-01-24',
                    time: '15:00',
                    duration: '60 minutes',
                    status: 'Scheduled'
                }
            ];
            
            if (upcomingLessons.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <i class="fas fa-calendar-times" style="font-size: 3rem; color: #ccc; margin-bottom: 16px;"></i>
                        <h4 style="margin: 0 0 8px 0; color: #999;">No Upcoming Lessons</h4>
                        <p style="margin: 0; color: #999;">You have no scheduled lessons for this week.</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = upcomingLessons.map(lesson => `
                <div style="background: white; border: 1px solid #e0e0e0; border-radius: 8px; padding: 16px; margin-bottom: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <div style="display: flex; justify-content: between; align-items: flex-start; margin-bottom: 12px;">
                        <div style="flex: 1;">
                            <h4 style="margin: 0 0 4px 0; color: var(--tutor-primary); font-size: 1.1rem;">${lesson.subject}</h4>
                            <p style="margin: 0; color: #666; font-size: 0.9rem;">Student: ${lesson.student}</p>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-weight: 600; color: #333; font-size: 1rem;">${lesson.time}</div>
                            <div style="color: #666; font-size: 0.8rem;">${lesson.date}</div>
                        </div>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; gap: 8px;">
                            <span style="background: #e8f5e8; color: #4caf50; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: 600;">
                                ${lesson.status}
                            </span>
                            <span style="background: #e3f2fd; color: var(--tutor-primary); padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;">
                                ${lesson.duration}
                            </span>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button onclick="startLesson('${lesson.id}')" style="background: #4caf50; color: white; border: none; border-radius: 6px; padding: 6px 12px; font-size: 0.8rem; cursor: pointer; display: flex; align-items: center; gap: 4px;" onmouseover="this.style.background='#45a049'" onmouseout="this.style.background='#4caf50'">
                                <i class="fas fa-play"></i> Start
                            </button>
                            <button onclick="rescheduleLesson('${lesson.id}')" style="background: #ff9800; color: white; border: none; border-radius: 6px; padding: 6px 12px; font-size: 0.8rem; cursor: pointer; display: flex; align-items: center; gap: 4px;" onmouseover="this.style.background='#f57c00'" onmouseout="this.style.background='#ff9800'">
                                <i class="fas fa-clock"></i> Reschedule
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        function startLesson(lessonId) {
            // Confirm before starting lesson
            if (confirm('Are you sure you want to start this lesson?')) {
                console.log('Starting lesson:', lessonId);
            // Redirect to lesson.html
            window.location.href = 'lesson.html';
            }
        }
        
        function rescheduleLesson(lessonId) {
            console.log('Opening reschedule modal for lesson:', lessonId);
            setUserInteracting(); // Set user interaction flag
            
            // Find the lesson data
            const lesson = findLessonById(lessonId);
            if (!lesson) {
                alert('Lesson not found!');
                return;
            }
            
            // Update modal title and current info
            document.getElementById('rescheduleTitle').textContent = `Reschedule ${lesson.subject}`;
            document.getElementById('rescheduleCurrentInfo').textContent = `Current: ${lesson.date} at ${lesson.time} (${lesson.student})`;
            
            // Initialize reschedule calendar
            initializeRescheduleCalendar(lesson);
            
            // Show modal
            const modal = document.getElementById('rescheduleModal');
            if (modal) {
                modal.style.display = 'flex';
                console.log('Reschedule modal opened successfully');
            } else {
                console.error('Reschedule modal not found!');
            }
        }
        
        function mySchedulePreviousWeek() {
            currentWeekOffset--;
            renderMyScheduleWeekCalendar();
            updateWeekRange();
        }
        
        function myScheduleNextWeek() {
            currentWeekOffset++;
            renderMyScheduleWeekCalendar();
            updateWeekRange();
        }
        
        function updateWeekRange() {
            const today = new Date();
            const monday = new Date(today);
            monday.setDate(today.getDate() - today.getDay() + 1 + (currentWeekOffset * 7));
            const sunday = new Date(monday);
            sunday.setDate(monday.getDate() + 6);
            
            const weekRange = document.getElementById('scheduleWeekRange');
            weekRange.textContent = `Week of ${monday.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}`;
        }
        
        // Reschedule Functions
        function findLessonById(lessonId) {
            // Demo lesson data - in real app this would come from database
            const demoLessons = {
                'L001': { id: 'L001', subject: 'Mathematics', day: 'Monday', time: '14:00', student: 'Nguyen Van A', date: '2024-01-20' },
                'L002': { id: 'L002', subject: 'Physics', day: 'Tuesday', time: '10:00', student: 'Le Thi B', date: '2024-01-21' },
                'L003': { id: 'L003', subject: 'Computer Science', day: 'Wednesday', time: '16:00', student: 'Tran Van C', date: '2024-01-22' },
                'L004': { id: 'L004', subject: 'Chemistry', day: 'Thursday', time: '09:00', student: 'Pham Thi D', date: '2024-01-23' },
                'L005': { id: 'L005', subject: 'Mathematics', day: 'Friday', time: '15:00', student: 'Hoang Van E', date: '2024-01-24' }
            };
            return demoLessons[lessonId];
        }
        
        function initializeRescheduleCalendar(lesson) {
            console.log('Initializing reschedule calendar for lesson:', lesson);
            
            // Generate calendar for next 2 weeks
            const calendar = document.getElementById('rescheduleCalendar');
            const timeSlots = document.getElementById('rescheduleTimeSlots');
            
            calendar.innerHTML = '';
            timeSlots.innerHTML = '';
            
            // Generate calendar days with actual dates
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            days.forEach((day, index) => {
                const dayElement = document.createElement('div');
                dayElement.style.cssText = `
                    padding: 8px; text-align: center; font-weight: 600; 
                    background: #f8f9fa; border-radius: 4px; font-size: 0.9rem;
                `;
                
                // Calculate actual date for this day
                const today = new Date();
                const monday = new Date(today);
                monday.setDate(today.getDate() - today.getDay() + 1);
                const dayDate = new Date(monday);
                dayDate.setDate(monday.getDate() + index);
                
                const dayNumber = dayDate.getDate();
                dayElement.innerHTML = `
                    <div>${day}</div>
                    <div style="font-size: 0.8rem; color: #666;">${dayNumber}</div>
                `;
                calendar.appendChild(dayElement);
            });
            
            // Generate time slots
            const availableTimes = ['09:00', '10:00', '11:00', '14:00', '15:00', '16:00'];
            availableTimes.forEach(time => {
                const timeSlot = document.createElement('button');
                timeSlot.style.cssText = `
                    padding: 8px 16px; border: 1px solid #e0e0e0; border-radius: 6px;
                    background: white; cursor: pointer; font-size: 0.9rem;
                    transition: all 0.2s;
                `;
                timeSlot.textContent = time;
                timeSlot.onclick = () => selectTimeSlot(time, timeSlot);
                timeSlots.appendChild(timeSlot);
            });
        }
        
        function selectTimeSlot(time, button) {
            // Remove active class from all time slots
            document.querySelectorAll('#rescheduleTimeSlots button').forEach(btn => {
                btn.style.background = 'white';
                btn.style.color = '#333';
            });
            
            // Add active class to selected time slot
            button.style.background = '#ff9800';
            button.style.color = 'white';
            
            // Show selected time display
            const selectedDisplay = document.getElementById('selectedTimeDisplay');
            selectedDisplay.style.display = 'block';
            selectedDisplay.textContent = `Selected: ${time}`;
            
            console.log('Time slot selected:', time);
        }
        
        function closeRescheduleModal() {
            console.log('Closing reschedule modal...');
            const modal = document.getElementById('rescheduleModal');
            if (modal) {
                modal.style.display = 'none';
                // Reset form
                document.getElementById('rescheduleReason').value = '';
                document.getElementById('selectedTimeDisplay').style.display = 'none';
            }
        }
        
        function submitRescheduleRequest() {
            const reason = document.getElementById('rescheduleReason').value.trim();
            const selectedTime = document.querySelector('#rescheduleTimeSlots button[style*="background: rgb(255, 152, 0)"]');
            
            if (!selectedTime) {
                alert('Please select a new time slot!');
                return;
            }
            
            if (!reason) {
                alert('Please provide a reason for rescheduling!');
                return;
            }
            
            const newTime = selectedTime.textContent;
            const currentInfo = document.getElementById('rescheduleCurrentInfo').textContent;
            console.log('Submitting reschedule request:', { newTime, reason, currentInfo });
            
            // In a real implementation, this would send the request to the backend
            alert(`âœ… Reschedule request sent!\n\nCurrent: ${currentInfo}\nNew time: ${newTime}\nReason: ${reason}\n\nRequest will be sent to the student for approval.`);
            
            closeRescheduleModal();
        }
        
        // Profile Functions
        function showProfileModal() {
            console.log('Opening profile modal...');
            setUserInteracting(); // Set user interaction flag
            const modal = document.getElementById('profileModal');
            if (modal) {
            modal.style.display = 'flex';
            loadTutorProfileData();
                
                // Ensure action buttons are visible by default
                const actionButtons = document.getElementById('profileActionButtons');
                if (actionButtons) {
                    actionButtons.style.display = 'flex';
                    console.log('Action buttons shown by default');
                } else {
                    console.error('Action buttons element not found!');
                }
                
                // Debug action buttons
                setTimeout(() => {
                    debugActionButtons();
                    // Force show action buttons
                    const actionButtons = document.getElementById('profileActionButtons');
                    if (actionButtons) {
                        actionButtons.style.setProperty('display', 'flex', 'important');
                        actionButtons.style.setProperty('visibility', 'visible', 'important');
                        actionButtons.style.setProperty('opacity', '1', 'important');
                        console.log('ðŸ”§ Force showed action buttons');
                    }
                }, 100);
                
                // Ensure About tab is active by default
                switchTab('about');
                
                // Add background click handler
                const handleBackgroundClick = (e) => {
                    if (e.target === modal) {
                        console.log('Background clicked - closing modal');
                        closeProfileModal();
                        modal.removeEventListener('click', handleBackgroundClick);
                    }
                };
                modal.addEventListener('click', handleBackgroundClick);
                
                // Debug: Monitor modal state
                const checkModalState = setInterval(() => {
                    if (modal.style.display !== 'flex') {
                        console.error('âŒ Profile modal was closed unexpectedly!');
                        console.error('Modal display style:', modal.style.display);
                        clearInterval(checkModalState);
                    }
                }, 500);
                
                // Stop monitoring after 10 seconds
                setTimeout(() => {
                    clearInterval(checkModalState);
                    console.log('âœ… Modal monitoring stopped');
                }, 10000);
            } else {
                console.error('Profile modal not found!');
            }
        }
        
        function closeProfileModal() {
            console.log('Closing profile modal...');
            console.log('Call stack:', new Error().stack);
            const modal = document.getElementById('profileModal');
            if (modal) {
            modal.style.display = 'none';
                // Reset any unsaved changes
                resetProfileForm();
                // Don't call showDashboardView() here to avoid conflicts
            }
        }
        
        // Debug function to check action buttons
        function debugActionButtons() {
            const actionButtons = document.getElementById('profileActionButtons');
            console.log('=== DEBUG ACTION BUTTONS ===');
            console.log('Element found:', !!actionButtons);
            if (actionButtons) {
                console.log('Display style:', actionButtons.style.display);
                console.log('Computed display:', window.getComputedStyle(actionButtons).display);
                console.log('Visibility:', actionButtons.style.visibility);
                console.log('Opacity:', actionButtons.style.opacity);
                console.log('Position:', actionButtons.style.position);
                console.log('Z-index:', actionButtons.style.zIndex);
                console.log('Height:', actionButtons.offsetHeight);
                console.log('Width:', actionButtons.offsetWidth);
                console.log('Parent display:', window.getComputedStyle(actionButtons.parentElement).display);
                console.log('Is visible in viewport:', actionButtons.getBoundingClientRect().height > 0);
            }
            console.log('===========================');
        }
        
        function loadTutorProfileData() {
            console.log('Loading tutor profile data...');
            try {
                // Try to load saved data from localStorage
                const savedData = localStorage.getItem('tutorProfileData');
                if (savedData) {
                    const profileData = JSON.parse(savedData);
                    console.log('Loaded saved profile data:', profileData);
                    
                    // Check if this is old format data and clear it
                    if (profileData.languages && typeof profileData.languages.english === 'boolean') {
                        console.log('Detected old format data, clearing localStorage...');
                        localStorage.removeItem('tutorProfileData');
                        return; // Exit and use default values
                    }
                    
                    // Apply saved data to form
                    if (profileData.introduction) {
                        const introField = document.getElementById('profileIntroduction');
                        if (introField) {
                            introField.value = profileData.introduction;
                        }
                    }
                    
                    // Apply saved preferences
                    if (profileData.preferences) {
                        const prefInput = document.getElementById('prefOpenToNew');
                        if (prefInput) {
                            // Handle both old format (openToNew boolean) and new format (studentPreferences string)
                            if (profileData.preferences.studentPreferences) {
                                // New format
                                prefInput.value = profileData.preferences.studentPreferences;
                            } else if (profileData.preferences.openToNew !== undefined) {
                                // Old format - convert boolean to appropriate text
                                if (profileData.preferences.openToNew) {
                                    prefInput.value = 'Open to new students';
                                } else {
                                    prefInput.value = 'Not accepting new students';
                                }
                            }
                        }
                    }
                    
                    // Apply saved languages
                    if (profileData.languages) {
                        const langInputs = {
                            'langEnglish': profileData.languages.english,
                            'langSpanish': profileData.languages.spanish
                        };
                        
                        Object.keys(langInputs).forEach(inputId => {
                            const input = document.getElementById(inputId);
                            if (input) {
                                // Handle both old format (boolean) and new format (string)
                                const value = langInputs[inputId];
                                if (typeof value === 'boolean') {
                                    // Old format - use default values
                                    if (inputId === 'langEnglish') {
                                        input.value = 'English (Native)';
                                    } else if (inputId === 'langSpanish') {
                                        input.value = 'Spanish (Conversational)';
                                    }
                                } else if (typeof value === 'string' && value.trim() !== '') {
                                    // New format - use saved string value
                                    input.value = value;
                                }
                            }
                        });
                    }
                    
                    // Apply saved industry preferences
                    if (profileData.industry) {
                        const indInputs = {
                            'indEducation': profileData.industry.education,
                            'indResearch': profileData.industry.research
                        };
                        
                        Object.keys(indInputs).forEach(inputId => {
                            const input = document.getElementById(inputId);
                            if (input) {
                                // Handle both old format (boolean) and new format (string)
                                const value = indInputs[inputId];
                                if (typeof value === 'boolean') {
                                    // Old format - use default values
                                    if (inputId === 'indEducation') {
                                        input.value = 'Education';
                                    } else if (inputId === 'indResearch') {
                                        input.value = 'Research';
                                    }
                                } else if (typeof value === 'string' && value.trim() !== '') {
                                    // New format - use saved string value
                                    input.value = value;
                                }
                            }
                        });
                    }
                } else {
                    console.log('No saved profile data found, using defaults');
                }
            } catch (error) {
                console.error('Error loading profile data:', error);
            }
        }
        
        function resetProfileForm() {
            console.log('Resetting profile form...');
            // Reset introduction to default
            const introField = document.getElementById('profileIntroduction');
            if (introField) {
                introField.value = "I'm from the United States and have been teaching mathematics and physics for eight years. I'm passionate about simplifying complex concepts and helping students understand real-world applications. My teaching style focuses on building strong foundations and developing problem-solving skills.";
            }
            
            // Reset all inputs to default state
            const inputs = [
                { id: 'prefOpenToNew', value: 'Open to new students' },
                { id: 'langEnglish', value: 'English (Native)' },
                { id: 'langSpanish', value: 'Spanish (Conversational)' },
                { id: 'indEducation', value: 'Education' },
                { id: 'indResearch', value: 'Research' }
            ];
            
            inputs.forEach(input => {
                const inputElement = document.getElementById(input.id);
                if (inputElement) {
                    inputElement.value = input.value;
                }
            });
            
            // Clear old localStorage data to prevent format conflicts
            localStorage.removeItem('tutorProfileData');
            console.log('Cleared old profile data from localStorage');
        }
        
        function switchTab(tabName) {
            console.log('Switching to tab:', tabName);
            
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => {
                content.style.display = 'none';
            });
            
            // Remove active class from all tabs
            const tabs = document.querySelectorAll('.profile-tab');
            tabs.forEach(tab => {
                tab.classList.remove('active');
                tab.style.fontWeight = '500';
                tab.style.color = '#666';
                tab.style.borderBottom = '3px solid transparent';
            });
            
            // Show selected tab content
            const selectedContent = document.getElementById(`tabContent${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`);
            if (selectedContent) {
                selectedContent.style.display = 'block';
                console.log('Tab content displayed:', tabName);
            } else {
                console.error('Tab content not found for:', tabName);
            }
            
            // Add active class to selected tab
            const selectedTab = document.getElementById(`tab${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`);
            if (selectedTab) {
                selectedTab.classList.add('active');
                selectedTab.style.fontWeight = '600';
                selectedTab.style.color = 'var(--tutor-primary)';
                selectedTab.style.borderBottom = '3px solid var(--tutor-primary)';
                console.log('Tab activated:', tabName);
            } else {
                console.error('Tab button not found for:', tabName);
            }
            
            // Show/hide action buttons based on tab
            const actionButtons = document.getElementById('profileActionButtons');
            console.log('Action buttons element found:', !!actionButtons);
            if (actionButtons) {
                console.log('Current action buttons display:', actionButtons.style.display);
                if (tabName === 'about') {
                    actionButtons.style.display = 'flex !important';
                    actionButtons.style.visibility = 'visible !important';
                    actionButtons.style.opacity = '1 !important';
                    console.log('âœ… Action buttons shown for About tab');
                } else {
                    actionButtons.style.display = 'none !important';
                    console.log('âŒ Action buttons hidden for', tabName, 'tab');
                }
                console.log('New action buttons display:', actionButtons.style.display);
            } else {
                console.error('âŒ Action buttons element not found!');
            }
        }
        

        
        function saveProfileChanges() {
            console.log('Saving profile changes...');
            
            try {
            // Get all the updated values
                const introductionField = document.getElementById('profileIntroduction');
                const prefInput = document.getElementById('prefOpenToNew');
                const langEnglishInput = document.getElementById('langEnglish');
                const langSpanishInput = document.getElementById('langSpanish');
                const indEducationInput = document.getElementById('indEducation');
                const indResearchInput = document.getElementById('indResearch');
                
                if (!introductionField || !prefInput || !langEnglishInput || !langSpanishInput || !indEducationInput || !indResearchInput) {
                    console.error('One or more profile elements not found');
                    alert('Error: Some profile elements are missing. Please refresh the page and try again.');
                    return;
                }
                
                const introduction = introductionField.value.trim();
                const studentPreferences = prefInput.value.trim();
                const englishLanguage = langEnglishInput.value.trim();
                const spanishLanguage = langSpanishInput.value.trim();
                const educationIndustry = indEducationInput.value.trim();
                const researchIndustry = indResearchInput.value.trim();
                
                // Validate introduction
                if (!introduction) {
                    alert('Please provide an introduction text.');
                    return;
                }
                
                // Create profile data object
            const profileData = {
                introduction: introduction,
                preferences: {
                    studentPreferences: studentPreferences
                },
                languages: {
                    english: englishLanguage,
                    spanish: spanishLanguage
                },
                industry: {
                    education: educationIndustry,
                    research: researchIndustry
                },
                lastUpdated: new Date().toISOString()
            };
            
                console.log('Profile data to save:', profileData);
                
                // Save to localStorage
            localStorage.setItem('tutorProfileData', JSON.stringify(profileData));
            
            // Show success message
            alert('Profile updated successfully! Your changes have been saved.');
                
                console.log('Profile saved successfully');
            
            // Close modal
            closeProfileModal();
                
            } catch (error) {
                console.error('Error saving profile:', error);
                alert('Error saving profile. Please try again.');
            }
        }
        
        // Create Lesson Functions
        function showCreateLessonModal() {
            console.log('showCreateLessonModal called - checking if this is intentional...');
            setUserInteracting(); // Set user interaction flag
            
            // Check if this is being called during page load
            if (document.readyState !== 'complete') {
                console.warn('showCreateLessonModal called during page load - ignoring');
                return;
            }
            
            // Additional check to prevent auto-opening
            const currentTime = Date.now();
            if (!window.lastModalOpenTime) {
                window.lastModalOpenTime = currentTime;
            } else if (currentTime - window.lastModalOpenTime < 1000) {
                console.warn('showCreateLessonModal called too quickly - ignoring');
                return;
            }
            window.lastModalOpenTime = currentTime;
            
            const modal = document.getElementById('createLessonModal');
            if (modal) {
            modal.style.display = 'flex';
            modal.style.alignItems = 'center';
            modal.style.justifyContent = 'center';
            setDefaultDate();
            updateLessonPreview();
                console.log('Create lesson modal opened successfully');
            } else {
                console.error('Create lesson modal not found!');
            }
        }
        
        function closeCreateLessonModal() {
            const modal = document.getElementById('createLessonModal');
            modal.style.display = 'none';
            resetLessonForm();
        }
        
        function setDefaultDate() {
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(today.getDate() + 1);
            
            const tomorrowStr = tomorrow.toISOString().split('T')[0];
            document.getElementById('singleDate').value = tomorrowStr;
        }
        
        function resetLessonForm() {
            // Reset lesson form
            document.getElementById('singleSubject').value = '';
            document.getElementById('singleDate').value = '';
            document.getElementById('singleStartTime').value = '';
            document.getElementById('singleDuration').value = '60';
            document.getElementById('singleDescription').value = '';
            
            // Reset preview
            document.getElementById('lessonPreview').innerHTML = 'Fill in the form above to see a preview of your lesson';
        }
        
        function updateLessonPreview() {
            const subject = document.getElementById('singleSubject').value;
            const date = document.getElementById('singleDate').value;
            const time = document.getElementById('singleStartTime').value;
            const duration = document.getElementById('singleDuration').value;
            const description = document.getElementById('singleDescription').value;
            
            if (!subject || !date || !time) {
                document.getElementById('lessonPreview').innerHTML = 'Fill in the required fields to see a preview';
                return;
            }
            
            const preview = `
                <div style="background: white; border: 1px solid #e0e0e0; border-radius: 6px; padding: 12px;">
                    <div style="font-weight: 600; color: var(--tutor-primary); margin-bottom: 8px;">${subject}</div>
                    <div style="color: #666; font-size: 0.9rem; margin-bottom: 4px;">
                        <i class="fas fa-calendar"></i> ${formatDate(date)} at ${time}
                    </div>
                    <div style="color: #666; font-size: 0.9rem; margin-bottom: 4px;">
                        <i class="fas fa-clock"></i> ${duration} minutes
                    </div>
                    <div style="color: #666; font-size: 0.9rem; margin-bottom: 4px;">
                        <i class="fas fa-user"></i> 1 student (Individual tutoring)
                    </div>
                    ${description ? `<div style="color: #666; font-size: 0.9rem; margin-top: 8px; padding-top: 8px; border-top: 1px solid #e0e0e0;">
                        ${description}
                    </div>` : ''}
                </div>
            `;
            
            document.getElementById('lessonPreview').innerHTML = preview;
        }
        
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { 
                weekday: 'short', 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
        }
        
        function createLesson() {
            console.log('Creating new lesson...');
            
            try {
            const subject = document.getElementById('singleSubject').value;
            const date = document.getElementById('singleDate').value;
            const time = document.getElementById('singleStartTime').value;
            const duration = document.getElementById('singleDuration').value;
            const description = document.getElementById('singleDescription').value;
            
            if (!subject || !date || !time) {
                alert('Please fill in all required fields!');
                return;
            }
                
                // Validate date is not in the past
                const lessonDate = new Date(date + ' ' + time);
                const now = new Date();
                if (lessonDate < now) {
                    alert('Lesson date and time cannot be in the past!');
                    return;
                }
            
            const lesson = {
                id: 'L' + Date.now(),
                subject: subject,
                tutor: 'Dr. Sarah Johnson',
                date: date,
                time: time,
                duration: duration + ' minutes',
                location: 'TBD',
                maxStudents: 1,
                description: description,
                status: 'Available',
                createdAt: new Date().toISOString()
            };
                
                console.log('Lesson data:', lesson);
            
            // Save to localStorage
            const existingLessons = JSON.parse(localStorage.getItem('tutorCreatedLessons') || '[]');
            existingLessons.push(lesson);
            localStorage.setItem('tutorCreatedLessons', JSON.stringify(existingLessons));
            
            // Show success message
            alert('Lesson created successfully!');
                
                console.log('Lesson created and saved');
            
            closeCreateLessonModal();
                
            } catch (error) {
                console.error('Error creating lesson:', error);
                alert('Error creating lesson. Please try again.');
            }
        }
        
        // Add event listeners for real-time preview updates
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Setting up lesson form event listeners...');
            
            // Lesson form listeners
            const fields = ['singleSubject', 'singleDate', 'singleStartTime', 'singleDuration', 'singleDescription'];
            fields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('input', updateLessonPreview);
                    field.addEventListener('change', updateLessonPreview);
                    console.log(`Event listener added for: ${fieldId}`);
                } else {
                    console.warn(`Field not found: ${fieldId}`);
                }
            });
            
            console.log('Lesson form event listeners setup completed');
        });
        
        function initializeCharts() {
            // Weekly Schedule Chart
            const weeklyCtx = document.getElementById('weeklyScheduleChart').getContext('2d');
            new Chart(weeklyCtx, {
                type: 'bar',
                data: {
                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                    datasets: [{
                        label: 'Lessons',
                        data: [3, 4, 2, 5, 3, 1, 0],
                        backgroundColor: '#4caf50',
                        borderColor: '#45a049',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 6
                        }
                    }
                }
            });
            
            // Student Performance Chart
            const performanceCtx = document.getElementById('studentPerformanceChart').getContext('2d');
            new Chart(performanceCtx, {
                type: 'line',
                data: {
                    labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
                    datasets: [{
                        label: 'Average Score',
                        data: [75, 82, 78, 85],
                        borderColor: '#007bff',
                        backgroundColor: 'rgba(0, 123, 255, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }
    </script>
</body>
</html> 
